name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Define defaults for secret-backed env vars so static analyzers can see the
# keys exist. At runtime these will be overridden by repository secrets when
# present.
env:
  VT_API_KEY: ''
  IPINFO_TOKEN: ''
  DNSDB_KEY: ''

jobs:
  # Stage 1: Linting & Code Quality
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      - name: Run flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Continue on style issues (don't fail on warnings)
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics --exclude=.git,__pycache__,venv
      - name: Check code formatting with black
        run: black --check .
      - name: Check import ordering with isort
        run: isort --check-only .

  # Stage 2: Unit Tests (Offline)
  test:
    name: Unit Tests (Offline)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
          pip install -e .
      - name: Create results directory
        run: mkdir -p results .cache
      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --tb=short --cov=core --cov=config --cov=modules --cov-report=term-missing -k "not integration"
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: .coverage

  # Stage 3: Smoke Test
  smoke-cli:
    name: CLI Smoke Test
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      - name: Run subfinder CLI smoke check (non-Tor)
        run: |
          # Run a very small smoke check of the CLI to catch runtime import regressions.
          mkdir -p results
          python -m cli.main subfinder example.com --no-tor --workers 1

  # Stage 4: Integration Tests (Optional - only on main with secrets)
  integration:
    name: Integration Tests (Networked)
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          pip install -e .
      - name: Create results directory
        run: mkdir -p results .cache
      - name: Run integration tests
        env:
          RUN_API_INTEGRATION: '1'
          # Use secrets directly; if they are not present the job will still
          # run in a limited/non-networked mode. The previous "|| ''" pattern
          # triggers some YAML analyzers with a false positive "invalid
          # context" warning, so we use direct secret expansion which is the
          # canonical GitHub Actions form.
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          IPINFO_TOKEN: ${{ secrets.IPINFO_TOKEN }}
          DNSDB_KEY: ${{ secrets.DNSDB_KEY }}
        run: |
          pytest tests/ -v --tb=short -k "integration"
